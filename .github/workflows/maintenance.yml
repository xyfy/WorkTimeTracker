name: Maintenance

on:
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š 8:00 UTC è¿è¡Œ
    - cron: '0 8 * * 1'
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'

jobs:
  # ä¾èµ–é¡¹å®‰å…¨æ‰«æ
  security-scan:
    name: ğŸ” Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore WorkTimeTracker.sln
      
    - name: ğŸ” Check for vulnerable packages
      run: |
        echo "## ğŸ” å®‰å…¨æ‰«ææŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "æ‰«ææ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥å·²çŸ¥æ¼æ´
        VULNERABLE_PACKAGES=$(dotnet list package --vulnerable --include-transitive 2>&1)
        
        if echo "$VULNERABLE_PACKAGES" | grep -q "has the following vulnerable packages"; then
          echo "âŒ **å‘ç°å®‰å…¨æ¼æ´**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$VULNERABLE_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "âœ… **æœªå‘ç°å®‰å…¨æ¼æ´**" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ğŸ“Š Generate security report
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸ” å®‰å…¨æ¼æ´æŠ¥å‘Š - ' + new Date().toISOString().split('T')[0],
            body: `## å®‰å…¨æ‰«æå‘ç°æ¼æ´
            
            åœ¨å®šæœŸå®‰å…¨æ‰«æä¸­å‘ç°äº†ä¾èµ–é¡¹æ¼æ´ã€‚
            
            **æ‰«ææ—¶é—´**: ${new Date().toLocaleString()}
            **å·¥ä½œæµ**: ${context.workflow}
            **è¿è¡ŒID**: ${context.runId}
            
            è¯·æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ï¼Œå¹¶åŠæ—¶æ›´æ–°ç›¸å…³ä¾èµ–é¡¹ã€‚
            
            ## å»ºè®®æ“ä½œ
            1. æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—ä¸­çš„æ¼æ´è¯¦æƒ…
            2. æ›´æ–°å—å½±å“çš„ NuGet åŒ…
            3. é‡æ–°è¿è¡Œæµ‹è¯•ç¡®ä¿åŠŸèƒ½æ­£å¸¸
            4. æäº¤æ›´æ–°çš„ä¾èµ–é¡¹
            `,
            labels: ['security', 'dependencies', 'maintenance']
          })

  # ä¾èµ–é¡¹æ›´æ–°æ£€æŸ¥
  dependency-update:
    name: ğŸ“¦ Dependency Update Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Check for outdated packages
      run: |
        echo "## ğŸ“¦ ä¾èµ–é¡¹æ›´æ–°æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
        echo "æ£€æŸ¥æ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥è¿‡æ—¶çš„åŒ…
        OUTDATED_PACKAGES=$(dotnet list package --outdated 2>&1)
        
        if echo "$OUTDATED_PACKAGES" | grep -q "has the following outdated packages"; then
          echo "ğŸ“‹ **å‘ç°å¯æ›´æ–°çš„åŒ…**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$OUTDATED_PACKAGES" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **æ‰€æœ‰åŒ…éƒ½æ˜¯æœ€æ–°ç‰ˆæœ¬**" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ğŸ”„ Create update issue
      if: contains(steps.*.outputs.*, 'outdated packages')
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸ“¦ ä¾èµ–é¡¹æ›´æ–°å»ºè®® - ' + new Date().toISOString().split('T')[0],
            body: `## ä¾èµ–é¡¹æ›´æ–°æ£€æŸ¥
            
            å®šæœŸæ‰«æå‘ç°äº†å¯æ›´æ–°çš„ä¾èµ–é¡¹ã€‚
            
            **æ£€æŸ¥æ—¶é—´**: ${new Date().toLocaleString()}
            **å·¥ä½œæµ**: ${context.workflow}
            **è¿è¡ŒID**: ${context.runId}
            
            è¯·æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—è·å–å¯æ›´æ–°åŒ…çš„è¯¦ç»†ä¿¡æ¯ã€‚
            
            ## å»ºè®®æ“ä½œ
            1. æŸ¥çœ‹å·¥ä½œæµæ‘˜è¦ä¸­çš„æ›´æ–°åˆ—è¡¨
            2. é€ä¸ªè¯„ä¼°æ›´æ–°çš„å¿…è¦æ€§å’Œå…¼å®¹æ€§
            3. åˆ›å»ºä¸“é—¨çš„ PR è¿›è¡Œä¾èµ–é¡¹æ›´æ–°
            4. ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡ååˆå¹¶
            
            ## æ³¨æ„äº‹é¡¹
            - ä¸»ç‰ˆæœ¬æ›´æ–°å¯èƒ½åŒ…å«ç ´åæ€§å˜æ›´
            - å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒä¸­å…ˆéªŒè¯æ›´æ–°
            - å…³æ³¨å®‰å…¨æ›´æ–°çš„ä¼˜å…ˆçº§
            `,
            labels: ['dependencies', 'maintenance', 'enhancement']
          })

  # ä»£ç è´¨é‡æŠ¥å‘Š
  code-quality-report:
    name: ğŸ“Š Code Quality Report
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²ç”¨äºè¶‹åŠ¿åˆ†æ
        
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“Š Analyze code metrics
      run: |
        echo "## ğŸ“Š ä»£ç è´¨é‡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "æŠ¥å‘Šæ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ç»Ÿè®¡ä»£ç è¡Œæ•°
        TOTAL_CS_FILES=$(find . -name "*.cs" -not -path "./bin/*" -not -path "./obj/*" -not -path "./.git/*" | wc -l)
        TOTAL_LINES=$(find . -name "*.cs" -not -path "./bin/*" -not -path "./obj/*" -not -path "./.git/*" -exec wc -l {} + | tail -1 | awk '{print $1}')
        
        echo "### ğŸ“ˆ ä»£ç ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        echo "- **C# æ–‡ä»¶æ•°**: $TOTAL_CS_FILES" >> $GITHUB_STEP_SUMMARY
        echo "- **æ€»ä»£ç è¡Œæ•°**: $TOTAL_LINES" >> $GITHUB_STEP_SUMMARY
        
        # é¡¹ç›®ç»“æ„åˆ†æ
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ—ï¸ é¡¹ç›®ç»“æ„" >> $GITHUB_STEP_SUMMARY
        for project in WorkTimeTracker.Core WorkTimeTracker.Data WorkTimeTracker.UI WorkTimeTracker.Tests WorkTimeTracker.UITests; do
          if [ -d "$project" ]; then
            FILES=$(find "$project" -name "*.cs" | wc -l)
            LINES=$(find "$project" -name "*.cs" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
            echo "- **$project**: $FILES æ–‡ä»¶, $LINES è¡Œ" >> $GITHUB_STEP_SUMMARY
          fi
        done
        
        # æœ€è¿‘æäº¤æ´»åŠ¨
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”„ æœ€è¿‘æ´»åŠ¨" >> $GITHUB_STEP_SUMMARY
        COMMITS_LAST_WEEK=$(git rev-list --count --since="1 week ago" HEAD)
        COMMITS_LAST_MONTH=$(git rev-list --count --since="1 month ago" HEAD)
        echo "- **æœ€è¿‘ä¸€å‘¨æäº¤æ•°**: $COMMITS_LAST_WEEK" >> $GITHUB_STEP_SUMMARY
        echo "- **æœ€è¿‘ä¸€æœˆæäº¤æ•°**: $COMMITS_LAST_MONTH" >> $GITHUB_STEP_SUMMARY
        
    - name: ğŸ§ª Test coverage analysis
      run: |
        # è¿è¡Œæµ‹è¯•ä»¥è·å–è¦†ç›–ç‡ä¿¡æ¯
        dotnet restore WorkTimeTracker.sln
        
        # è¿è¡Œå•å…ƒæµ‹è¯•
        if [ -d "WorkTimeTracker.Tests" ]; then
          TEST_RESULT=$(dotnet test WorkTimeTracker.Tests/WorkTimeTracker.Tests.csproj --verbosity quiet --logger "console;verbosity=minimal" 2>&1)
          TEST_COUNT=$(echo "$TEST_RESULT" | grep -o "Total tests: [0-9]*" | grep -o "[0-9]*" || echo "0")
          PASSED_COUNT=$(echo "$TEST_RESULT" | grep -o "Passed: [0-9]*" | grep -o "[0-9]*" || echo "0")
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ§ª æµ‹è¯•è¦†ç›–ç‡" >> $GITHUB_STEP_SUMMARY
          echo "- **å•å…ƒæµ‹è¯•æ•°é‡**: $TEST_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **é€šè¿‡æµ‹è¯•æ•°é‡**: $PASSED_COUNT" >> $GITHUB_STEP_SUMMARY
          
          if [ "$TEST_COUNT" -gt 0 ]; then
            SUCCESS_RATE=$(( PASSED_COUNT * 100 / TEST_COUNT ))
            echo "- **æµ‹è¯•é€šè¿‡ç‡**: $SUCCESS_RATE%" >> $GITHUB_STEP_SUMMARY
          fi
        fi

  # æ¸…ç†è¿‡æœŸå·¥ä»¶
  cleanup-artifacts:
    name: ğŸ§¹ Cleanup Artifacts
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ§¹ Delete old artifacts
      uses: actions/github-script@v7
      with:
        script: |
          // è·å–æ‰€æœ‰å·¥ä»¶
          const artifacts = await github.rest.actions.listArtifactsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          // åˆ é™¤è¶…è¿‡30å¤©çš„å·¥ä»¶
          const thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
          
          let deletedCount = 0;
          
          for (const artifact of artifacts.data.artifacts) {
            const createdAt = new Date(artifact.created_at);
            if (createdAt < thirtyDaysAgo) {
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id,
              });
              deletedCount++;
            }
          }
          
          console.log(`ğŸ§¹ æ¸…ç†äº† ${deletedCount} ä¸ªè¿‡æœŸå·¥ä»¶`);
          
          // è®°å½•åˆ°æ‘˜è¦
          core.summary.addHeading('ğŸ§¹ å·¥ä»¶æ¸…ç†æŠ¥å‘Š', 2);
          core.summary.addRaw(`æ¸…ç†äº† ${deletedCount} ä¸ªè¶…è¿‡30å¤©çš„å·¥ä»¶`);
          core.summary.addRaw(`\næ¸…ç†æ—¶é—´: ${new Date().toLocaleString()}`);
          await core.summary.write();
