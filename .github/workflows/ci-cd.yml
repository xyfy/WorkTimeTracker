name: CI/CD Pipeline

on:
  push:
    branches: [ main, dev, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  DOTNET_VERSION: '9.0.x'
  SOLUTION_FILE: 'WorkTimeTracker.sln'

jobs:
  # 1. è‡ªåŠ¨ç¼–è¯‘ç¨‹åº
  build:
    name: ğŸ”¨ Build
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}
      
    - name: ğŸ”¨ Build solution
      run: dotnet build ${{ env.SOLUTION_FILE }} --configuration Release --no-restore
      
    - name: ğŸ“ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          **/bin/Release/**
          !**/bin/Release/**/ref/**
          !**/bin/Release/**/*.pdb
        retention-days: 30

  # 2. è‡ªåŠ¨æµ‹è¯•ç¨‹åº
  test:
    name: ğŸ§ª Test
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}
      
    - name: ğŸ”¨ Build for testing
      run: dotnet build ${{ env.SOLUTION_FILE }} --configuration Release --no-restore
      
    - name: ğŸ§ª Run unit tests
      run: |
        dotnet test WorkTimeTracker.Tests/WorkTimeTracker.Tests.csproj \
          --configuration Release \
          --no-build \
          --verbosity normal \
          --logger trx \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults
          
    - name: ğŸ§ª Run UI tests (if available)
      run: |
        if [ -d "WorkTimeTracker.UITests" ]; then
          echo "ğŸ” Running UI tests..."
          dotnet test WorkTimeTracker.UITests/WorkTimeTracker.UITests.csproj \
            --configuration Release \
            --no-build \
            --verbosity normal \
            --logger trx \
            --results-directory ./TestResults
        else
          echo "âš ï¸ No UI tests found, skipping..."
        fi
      continue-on-error: true
      
    - name: ğŸ“Š Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: TestResults/
        retention-days: 30
        
    - name: ğŸ“ˆ Publish test results
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Test Results
        path: TestResults/*.trx
        reporter: dotnet-trx

  # 3. ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}
      
    - name: ğŸ” Run code analysis
      run: |
        dotnet build ${{ env.SOLUTION_FILE }} \
          --configuration Release \
          --no-restore \
          --verbosity normal \
          /p:TreatWarningsAsErrors=false \
          /p:RunAnalyzersDuringBuild=true

  # 4. è·¨å¹³å°æ„å»º (MAUI)
  build-multiplatform:
    name: ğŸŒ Multi-platform Build
    runs-on: ${{ matrix.os }}
    needs: [build, test]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    
    strategy:
      matrix:
        os: [windows-latest, macos-latest]
        include:
          - os: windows-latest
            platform: windows
            target: net9.0-windows10.0.19041.0
          - os: macos-latest
            platform: macos
            target: net9.0-maccatalyst
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Install MAUI workloads
      run: dotnet workload install maui
      
    - name: ğŸ“¦ Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}
      
    - name: ğŸ”¨ Build MAUI app for ${{ matrix.platform }}
      run: |
        dotnet build WorkTimeTracker.UI/WorkTimeTracker.UI.csproj \
          -f ${{ matrix.target }} \
          -c Release \
          --no-restore
          
    - name: ğŸ“ Upload platform artifacts
      uses: actions/upload-artifact@v4
      with:
        name: app-${{ matrix.platform }}
        path: |
          WorkTimeTracker.UI/bin/Release/${{ matrix.target }}/**
          !**/*.pdb
        retention-days: 30

  # 5. è‡ªåŠ¨å‘å¸ƒç¨‹åº
  release:
    name: ğŸš€ Release
    runs-on: ubuntu-latest
    needs: [build, test, code-quality, build-multiplatform]
    if: github.event_name == 'release' && github.event.action == 'published'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        
    - name: ğŸ“¦ Create release packages
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p ./release-packages
        
        # æ‰“åŒ… Windows ç‰ˆæœ¬
        if [ -d "./artifacts/app-windows" ]; then
          cd ./artifacts/app-windows
          zip -r ../../release-packages/WorkTimeTracker-Windows-${{ github.event.release.tag_name }}.zip .
          cd ../..
        fi
        
        # æ‰“åŒ… macOS ç‰ˆæœ¬
        if [ -d "./artifacts/app-macos" ]; then
          cd ./artifacts/app-macos
          tar -czf ../../release-packages/WorkTimeTracker-macOS-${{ github.event.release.tag_name }}.tar.gz .
          cd ../..
        fi
        
        # åˆ›å»ºæºç åŒ…
        git archive --format=zip --prefix=WorkTimeTracker-${{ github.event.release.tag_name }}/ HEAD > ./release-packages/WorkTimeTracker-Source-${{ github.event.release.tag_name }}.zip
        
    - name: ğŸ“‹ Generate release notes
      run: |
        echo "## ğŸ‰ WorkTimeTracker ${{ github.event.release.tag_name }}" > release-notes.md
        echo "" >> release-notes.md
        echo "### ğŸ“¦ ä¸‹è½½" >> release-notes.md
        echo "- **Windows**: WorkTimeTracker-Windows-${{ github.event.release.tag_name }}.zip" >> release-notes.md
        echo "- **macOS**: WorkTimeTracker-macOS-${{ github.event.release.tag_name }}.tar.gz" >> release-notes.md
        echo "- **æºç **: WorkTimeTracker-Source-${{ github.event.release.tag_name }}.zip" >> release-notes.md
        echo "" >> release-notes.md
        echo "### ğŸ”§ æŠ€æœ¯æ ˆ" >> release-notes.md
        echo "- .NET 9.0" >> release-notes.md
        echo "- .NET MAUI" >> release-notes.md
        echo "- SQLite" >> release-notes.md
        echo "" >> release-notes.md
        echo "### ğŸ“± æ”¯æŒå¹³å°" >> release-notes.md
        echo "- Windows 10/11" >> release-notes.md
        echo "- macOS (Mac Catalyst)" >> release-notes.md
        echo "" >> release-notes.md
        echo "æ„å»ºæ—¶é—´: $(date)" >> release-notes.md
        echo "æ„å»ºåˆ†æ”¯: ${{ github.ref_name }}" >> release-notes.md
        echo "æäº¤å“ˆå¸Œ: ${{ github.sha }}" >> release-notes.md
        
    - name: ğŸš€ Upload release assets
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./release-packages/*
        body_path: release-notes.md
        draft: false
        prerelease: ${{ contains(github.event.release.tag_name, 'alpha') || contains(github.event.release.tag_name, 'beta') || contains(github.event.release.tag_name, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 6. éƒ¨ç½²åˆ°åŒ…ç®¡ç†å™¨ (å¯é€‰)
  deploy-packages:
    name: ğŸ“¦ Deploy Packages
    runs-on: ubuntu-latest
    needs: release
    if: github.event_name == 'release' && github.event.action == 'published' && !contains(github.event.release.tag_name, 'alpha') && !contains(github.event.release.tag_name, 'beta')
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Create NuGet packages
      run: |
        dotnet pack WorkTimeTracker.Core/WorkTimeTracker.Core.csproj \
          -c Release \
          --output ./nuget-packages \
          -p:PackageVersion=${{ github.event.release.tag_name }}
          
        dotnet pack WorkTimeTracker.Data/WorkTimeTracker.Data.csproj \
          -c Release \
          --output ./nuget-packages \
          -p:PackageVersion=${{ github.event.release.tag_name }}
          
    - name: ğŸš€ Publish to NuGet (if configured)
      run: |
        if [ ! -z "${{ secrets.NUGET_API_KEY }}" ]; then
          dotnet nuget push ./nuget-packages/*.nupkg \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate
        else
          echo "âš ï¸ NuGet API key not configured, skipping package publish"
        fi
