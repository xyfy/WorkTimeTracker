name: Code Quality

on:
  push:
    branches: [ main, dev, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤©æ—©ä¸Š9ç‚¹è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥
    - cron: '0 9 * * *'
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'

jobs:
  # ä»£ç æ ¼å¼æ£€æŸ¥
  code-formatting:
    name: ðŸ“ Code Formatting
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ðŸ“ Check code formatting
      run: |
        echo "ðŸ” æ£€æŸ¥ä»£ç æ ¼å¼..."
        dotnet format --verify-no-changes --verbosity diagnostic || {
          echo "âŒ ä»£ç æ ¼å¼ä¸ç¬¦åˆæ ‡å‡†"
          echo "è¯·è¿è¡Œ 'dotnet format' æ¥ä¿®å¤æ ¼å¼é—®é¢˜"
          exit 1
        }
        echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"

  # é™æ€åˆ†æž
  static-analysis:
    name: ðŸ” Static Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore WorkTimeTracker.sln
      
    - name: ðŸ” Run static analysis
      run: |
        echo "## ðŸ” é™æ€åˆ†æžæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # è¿è¡Œåˆ†æžå™¨
        dotnet build WorkTimeTracker.sln \
          --configuration Release \
          --no-restore \
          --verbosity normal \
          /p:TreatWarningsAsErrors=false \
          /p:RunAnalyzersDuringBuild=true \
          /p:EnableNETAnalyzers=true \
          /p:AnalysisLevel=latest \
          > analysis.log 2>&1
          
        # ç»Ÿè®¡è­¦å‘Šå’Œé”™è¯¯
        WARNINGS=$(grep -c "warning" analysis.log || echo "0")
        ERRORS=$(grep -c "error" analysis.log || echo "0")
        
        echo "- **è­¦å‘Šæ•°é‡**: $WARNINGS" >> $GITHUB_STEP_SUMMARY
        echo "- **é”™è¯¯æ•°é‡**: $ERRORS" >> $GITHUB_STEP_SUMMARY
        
        if [ "$ERRORS" -gt 0 ]; then
          echo "âŒ å‘çŽ°ç¼–è¯‘é”™è¯¯" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
        
        if [ "$WARNINGS" -gt 50 ]; then
          echo "âš ï¸ è­¦å‘Šæ•°é‡è¿‡å¤šï¼Œå»ºè®®æ¸…ç†" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… ä»£ç è´¨é‡è‰¯å¥½" >> $GITHUB_STEP_SUMMARY
        fi

  # ä»£ç å¤æ‚åº¦åˆ†æž
  complexity-analysis:
    name: ðŸ“Š Complexity Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“Š Analyze code complexity
      run: |
        echo "## ðŸ“Š ä»£ç å¤æ‚åº¦åˆ†æž" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ç»Ÿè®¡å„ç±»æ–‡ä»¶æ•°é‡
        CS_FILES=$(find . -name "*.cs" -not -path "./bin/*" -not -path "./obj/*" -not -path "./.git/*" | wc -l)
        XAML_FILES=$(find . -name "*.xaml" -not -path "./bin/*" -not -path "./obj/*" | wc -l)
        CSPROJ_FILES=$(find . -name "*.csproj" | wc -l)
        
        echo "### ðŸ“ æ–‡ä»¶ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        echo "- **C# æ–‡ä»¶**: $CS_FILES" >> $GITHUB_STEP_SUMMARY
        echo "- **XAML æ–‡ä»¶**: $XAML_FILES" >> $GITHUB_STEP_SUMMARY
        echo "- **é¡¹ç›®æ–‡ä»¶**: $CSPROJ_FILES" >> $GITHUB_STEP_SUMMARY
        
        # åˆ†æžå¹³å‡æ–‡ä»¶é•¿åº¦
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ ä»£ç åº¦é‡" >> $GITHUB_STEP_SUMMARY
        
        if [ "$CS_FILES" -gt 0 ]; then
          AVG_LINES=$(find . -name "*.cs" -not -path "./bin/*" -not -path "./obj/*" -not -path "./.git/*" -exec wc -l {} + | awk '{sum+=$1; count++} END {if(count>0) print int(sum/count); else print 0}')
          TOTAL_LINES=$(find . -name "*.cs" -not -path "./bin/*" -not -path "./obj/*" -not -path "./.git/*" -exec wc -l {} + | tail -1 | awk '{print $1}')
          
          echo "- **æ€»ä»£ç è¡Œæ•°**: $TOTAL_LINES" >> $GITHUB_STEP_SUMMARY
          echo "- **å¹³å‡æ–‡ä»¶é•¿åº¦**: $AVG_LINES è¡Œ" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥æ˜¯å¦æœ‰è¶…é•¿æ–‡ä»¶
          LONG_FILES=$(find . -name "*.cs" -not -path "./bin/*" -not -path "./obj/*" -not -path "./.git/*" -exec wc -l {} + | awk '$1 > 500 {print $2 " (" $1 " è¡Œ)"}' | head -5)
          if [ ! -z "$LONG_FILES" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âš ï¸ è¾ƒé•¿çš„æ–‡ä»¶ (>500è¡Œ)" >> $GITHUB_STEP_SUMMARY
            echo "$LONG_FILES" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        # åˆ†æžæ–¹æ³•å¤æ‚åº¦ï¼ˆç®€åŒ–ç‰ˆï¼‰
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ å¤æ‚åº¦æŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
        
        # ç»Ÿè®¡ç±»çš„æ•°é‡
        CLASS_COUNT=$(grep -r "class " . --include="*.cs" | grep -v "/bin/" | grep -v "/obj/" | wc -l)
        INTERFACE_COUNT=$(grep -r "interface " . --include="*.cs" | grep -v "/bin/" | grep -v "/obj/" | wc -l)
        
        echo "- **ç±»çš„æ•°é‡**: $CLASS_COUNT" >> $GITHUB_STEP_SUMMARY
        echo "- **æŽ¥å£æ•°é‡**: $INTERFACE_COUNT" >> $GITHUB_STEP_SUMMARY

  # å®‰å…¨æ‰«æ
  security-scan:
    name: ðŸ” Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore WorkTimeTracker.sln
      
    - name: ðŸ” Security vulnerability scan
      run: |
        echo "## ðŸ” å®‰å…¨æ‰«ææŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥å·²çŸ¥æ¼æ´ž
        SCAN_RESULT=$(dotnet list package --vulnerable --include-transitive 2>&1)
        
        if echo "$SCAN_RESULT" | grep -q "has the following vulnerable packages"; then
          echo "âŒ **å‘çŽ°å®‰å…¨æ¼æ´ž**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "$SCAN_RESULT" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          
          # åˆ›å»ºå®‰å…¨é—®é¢˜
          echo "SECURITY_ISSUES=true" >> $GITHUB_ENV
        else
          echo "âœ… **æœªå‘çŽ°å®‰å…¨æ¼æ´ž**" >> $GITHUB_STEP_SUMMARY
          echo "SECURITY_ISSUES=false" >> $GITHUB_ENV
        fi
        
    - name: ðŸ” Check for hardcoded secrets
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” å¯†é’¥æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
        
        # ç®€å•çš„å¯†é’¥æ¨¡å¼æ£€æŸ¥
        POTENTIAL_SECRETS=$(grep -r -i "password\|secret\|key\|token" . --include="*.cs" --include="*.json" --include="*.xml" | grep -v "/bin/" | grep -v "/obj/" | grep -v "// " | grep -v "/// " | wc -l)
        
        if [ "$POTENTIAL_SECRETS" -gt 0 ]; then
          echo "âš ï¸ å‘çŽ° $POTENTIAL_SECRETS å¤„å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æ£€æŸ¥æ˜¯å¦æœ‰ç¡¬ç¼–ç çš„å¯†é’¥æˆ–å¯†ç " >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… æœªå‘çŽ°æ˜Žæ˜¾çš„ç¡¬ç¼–ç å¯†é’¥" >> $GITHUB_STEP_SUMMARY
        fi

  # æµ‹è¯•è¦†ç›–çŽ‡
  test-coverage:
    name: ðŸ“ˆ Test Coverage
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore WorkTimeTracker.sln
      
    - name: ðŸ§ª Run tests with coverage
      run: |
        echo "## ðŸ“ˆ æµ‹è¯•è¦†ç›–çŽ‡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # è¿è¡Œå•å…ƒæµ‹è¯•
        if [ -d "WorkTimeTracker.Tests" ]; then
          dotnet test WorkTimeTracker.Tests/WorkTimeTracker.Tests.csproj \
            --configuration Release \
            --collect:"XPlat Code Coverage" \
            --logger "console;verbosity=detailed" \
            --results-directory ./TestResults \
            > test-output.log 2>&1
            
          # è§£æžæµ‹è¯•ç»“æžœ
          TOTAL_TESTS=$(grep -o "Total tests: [0-9]*" test-output.log | grep -o "[0-9]*" || echo "0")
          PASSED_TESTS=$(grep -o "Passed: [0-9]*" test-output.log | grep -o "[0-9]*" || echo "0")
          FAILED_TESTS=$(grep -o "Failed: [0-9]*" test-output.log | grep -o "[0-9]*" || echo "0")
          SKIPPED_TESTS=$(grep -o "Skipped: [0-9]*" test-output.log | grep -o "[0-9]*" || echo "0")
          
          echo "### ðŸ§ª å•å…ƒæµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "- **æ€»æµ‹è¯•æ•°**: $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
          echo "- **é€šè¿‡**: $PASSED_TESTS" >> $GITHUB_STEP_SUMMARY
          echo "- **å¤±è´¥**: $FAILED_TESTS" >> $GITHUB_STEP_SUMMARY
          echo "- **è·³è¿‡**: $SKIPPED_TESTS" >> $GITHUB_STEP_SUMMARY
          
          if [ "$TOTAL_TESTS" -gt 0 ]; then
            SUCCESS_RATE=$(( PASSED_TESTS * 100 / TOTAL_TESTS ))
            echo "- **æˆåŠŸçŽ‡**: $SUCCESS_RATE%" >> $GITHUB_STEP_SUMMARY
            
            if [ "$SUCCESS_RATE" -lt 80 ]; then
              echo "âš ï¸ æµ‹è¯•æˆåŠŸçŽ‡ä½ŽäºŽ80%ï¼Œéœ€è¦å…³æ³¨" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æµ‹è¯•é¡¹ç›®" >> $GITHUB_STEP_SUMMARY
        fi
        
        # æ£€æŸ¥UIæµ‹è¯•
        if [ -d "WorkTimeTracker.UITests" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ–¥ï¸ UIæµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "- **UIæµ‹è¯•é¡¹ç›®**: å·²é…ç½®" >> $GITHUB_STEP_SUMMARY
          
          UI_TEST_COUNT=$(dotnet test WorkTimeTracker.UITests/WorkTimeTracker.UITests.csproj --list-tests 2>/dev/null | grep "WorkTimeTracker.UITests" | wc -l || echo "0")
          echo "- **UIæµ‹è¯•æ•°é‡**: $UI_TEST_COUNT" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: ðŸ“Š Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: TestResults/
        retention-days: 30

  # è´¨é‡é—¨æ£€æŸ¥
  quality-gate:
    name: ðŸšª Quality Gate
    runs-on: ubuntu-latest
    needs: [code-formatting, static-analysis, complexity-analysis, security-scan, test-coverage]
    if: always()
    
    steps:
    - name: ðŸšª Evaluate quality gate
      run: |
        echo "## ðŸšª è´¨é‡é—¨æ£€æŸ¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥å„ä¸ªä»»åŠ¡çš„çŠ¶æ€
        FORMATTING_STATUS="${{ needs.code-formatting.result }}"
        ANALYSIS_STATUS="${{ needs.static-analysis.result }}"
        COMPLEXITY_STATUS="${{ needs.complexity-analysis.result }}"
        SECURITY_STATUS="${{ needs.security-scan.result }}"
        COVERAGE_STATUS="${{ needs.test-coverage.result }}"
        
        echo "### ðŸ“‹ æ£€æŸ¥é¡¹ç›®çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "- **ä»£ç æ ¼å¼**: $FORMATTING_STATUS" >> $GITHUB_STEP_SUMMARY
        echo "- **é™æ€åˆ†æž**: $ANALYSIS_STATUS" >> $GITHUB_STEP_SUMMARY
        echo "- **å¤æ‚åº¦åˆ†æž**: $COMPLEXITY_STATUS" >> $GITHUB_STEP_SUMMARY
        echo "- **å®‰å…¨æ‰«æ**: $SECURITY_STATUS" >> $GITHUB_STEP_SUMMARY
        echo "- **æµ‹è¯•è¦†ç›–çŽ‡**: $COVERAGE_STATUS" >> $GITHUB_STEP_SUMMARY
        
        # åˆ¤æ–­è´¨é‡é—¨æ˜¯å¦é€šè¿‡
        if [ "$FORMATTING_STATUS" = "success" ] && [ "$ANALYSIS_STATUS" = "success" ] && [ "$SECURITY_STATUS" = "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **è´¨é‡é—¨æ£€æŸ¥é€šè¿‡** - ä»£ç è´¨é‡ç¬¦åˆè¦æ±‚" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **è´¨é‡é—¨æ£€æŸ¥æœªé€šè¿‡** - è¯·ä¿®å¤ç›¸å…³é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
