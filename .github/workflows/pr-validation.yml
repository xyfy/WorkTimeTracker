name: PR Validation

on:
  pull_request:
    branches: [ main, dev, develop ]
    types: [opened, synchronize, reopened]

env:
  DOTNET_VERSION: '9.0.x'

jobs:
  # å¿«é€ŸéªŒè¯æž„å»ºå’Œæµ‹è¯•
  validate:
    name: ðŸ” Validate PR
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ç”¨äºŽæ›´å¥½çš„åˆ†æž
        
    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore WorkTimeTracker.sln
      
    - name: ðŸ”¨ Build solution
      run: dotnet build WorkTimeTracker.sln --configuration Debug --no-restore
      
    - name: ðŸ§ª Run unit tests
      run: |
        dotnet test WorkTimeTracker.Tests/WorkTimeTracker.Tests.csproj \
          --configuration Debug \
          --no-build \
          --verbosity normal \
          --logger "console;verbosity=detailed"
          
    - name: ðŸ” Check code formatting
      run: |
        dotnet format --verify-no-changes --verbosity diagnostic
        
    - name: ðŸ“Š Comment PR with results
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const output = `## ðŸ” PR éªŒè¯ç»“æžœ
          
          - âœ… ä»£ç æ£€å‡º: æˆåŠŸ
          - âœ… .NET çŽ¯å¢ƒ: ${{ env.DOTNET_VERSION }}
          - âœ… ä¾èµ–è¿˜åŽŸ: å®Œæˆ
          - âœ… é¡¹ç›®æž„å»º: é€šè¿‡
          - âœ… å•å…ƒæµ‹è¯•: é€šè¿‡
          - âœ… ä»£ç æ ¼å¼: æ£€æŸ¥å®Œæˆ
          
          **æž„å»ºæ—¶é—´**: ${new Date().toLocaleString()}
          **æäº¤å“ˆå¸Œ**: ${{ github.event.pull_request.head.sha }}
          **åˆ†æ”¯**: ${{ github.event.pull_request.head.ref }}
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });

  # ä»£ç è´¨é‡æ£€æŸ¥
  code-analysis:
    name: ðŸ“‹ Code Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore WorkTimeTracker.sln
      
    - name: ðŸ” Run static analysis
      run: |
        dotnet build WorkTimeTracker.sln \
          --configuration Debug \
          --no-restore \
          /p:TreatWarningsAsErrors=false \
          /p:RunAnalyzersDuringBuild=true \
          /p:EnableNETAnalyzers=true
          
    - name: ðŸ“ Check code metrics
      run: |
        echo "ðŸ“Š ä»£ç å¤æ‚åº¦åˆ†æž..."
        find . -name "*.cs" -not -path "./bin/*" -not -path "./obj/*" | wc -l > code-metrics.txt
        echo "C# æ–‡ä»¶æ€»æ•°: $(cat code-metrics.txt)" >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸ” Security scan
      run: |
        echo "ðŸ” å®‰å…¨æ€§æ‰«æ..."
        dotnet list package --vulnerable --include-transitive || true
        
  # å˜æ›´å½±å“åˆ†æž
  change-analysis:
    name: ðŸ“ˆ Change Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ“Š Analyze changes
      run: |
        echo "## ðŸ“ˆ å˜æ›´åˆ†æž" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ç»Ÿè®¡æ–‡ä»¶å˜æ›´
        CHANGED_FILES=$(git diff --name-only origin/main..HEAD | wc -l)
        echo "**å˜æ›´æ–‡ä»¶æ•°**: $CHANGED_FILES" >> $GITHUB_STEP_SUMMARY
        
        # ç»Ÿè®¡ä»£ç è¡Œå˜æ›´
        LINES_ADDED=$(git diff --numstat origin/main..HEAD | awk '{sum+=$1} END {print sum}')
        LINES_DELETED=$(git diff --numstat origin/main..HEAD | awk '{sum+=$2} END {print sum}')
        echo "**æ–°å¢žè¡Œæ•°**: ${LINES_ADDED:-0}" >> $GITHUB_STEP_SUMMARY
        echo "**åˆ é™¤è¡Œæ•°**: ${LINES_DELETED:-0}" >> $GITHUB_STEP_SUMMARY
        
        # æ–‡ä»¶ç±»åž‹ç»Ÿè®¡
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ å˜æ›´æ–‡ä»¶ç±»åž‹" >> $GITHUB_STEP_SUMMARY
        git diff --name-only origin/main..HEAD | sed 's/.*\.//' | sort | uniq -c | sort -nr >> $GITHUB_STEP_SUMMARY
        
        # å˜æ›´çš„é¡¹ç›®
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ å½±å“çš„é¡¹ç›®" >> $GITHUB_STEP_SUMMARY
        git diff --name-only origin/main..HEAD | grep -E '\.(cs|csproj|xaml)$' | cut -d'/' -f1 | sort | uniq >> $GITHUB_STEP_SUMMARY
