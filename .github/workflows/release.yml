name: Release Build

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      create_release:
        description: 'Create GitHub release'
        required: false
        default: true
        type: boolean

env:
  DOTNET_VERSION: '9.0.x'
  
jobs:
  # Windows æž„å»º
  build-windows:
    name: ðŸªŸ Build Windows
    runs-on: windows-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ðŸ“¦ Install MAUI workloads
      run: dotnet workload install maui
      
    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore WorkTimeTracker.sln
      
    - name: ðŸ”¨ Build Windows app
      run: |
        dotnet publish WorkTimeTracker.UI/WorkTimeTracker.UI.csproj `
          -f net9.0-windows10.0.19041.0 `
          -c Release `
          -p:PublishProfile=win-x64 `
          -p:PublishSingleFile=true `
          -p:PublishReadyToRun=true `
          -p:RuntimeIdentifier=win-x64 `
          --self-contained true `
          --output ./publish/windows
          
    - name: ðŸ“¦ Create Windows installer
      run: |
        # åˆ›å»ºå®‰è£…åŒ…ç›®å½•ç»“æž„
        mkdir -p ./installer/windows
        Copy-Item -Recurse ./publish/windows/* ./installer/windows/
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        @"
        @echo off
        echo Starting WorkTimeTracker...
        "%~dp0WorkTimeTracker.UI.exe"
        "@ | Out-File -FilePath "./installer/windows/start.bat" -Encoding ASCII
        
        # åˆ›å»ºå¸è½½è„šæœ¬
        @"
        @echo off
        echo Uninstalling WorkTimeTracker...
        rmdir /s /q "%~dp0"
        "@ | Out-File -FilePath "./installer/windows/uninstall.bat" -Encoding ASCII
        
    - name: ðŸ“ Create Windows package
      run: |
        $VERSION = "${{ github.event.release.tag_name || inputs.version }}"
        Compress-Archive -Path "./installer/windows/*" -DestinationPath "./WorkTimeTracker-Windows-$VERSION.zip"
        
    - name: ðŸ“¤ Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-package
        path: "./WorkTimeTracker-Windows-*.zip"
        retention-days: 30

  # macOS æž„å»º
  build-macos:
    name: ðŸŽ Build macOS
    runs-on: macos-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ðŸ“¦ Install MAUI workloads
      run: dotnet workload install maui
      
    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore WorkTimeTracker.sln
      
    - name: ðŸ”¨ Build macOS app
      run: |
        dotnet publish WorkTimeTracker.UI/WorkTimeTracker.UI.csproj \
          -f net9.0-maccatalyst \
          -c Release \
          -p:PublishProfile=macos \
          -p:CreatePackage=true \
          -p:RuntimeIdentifier=maccatalyst-x64 \
          --output ./publish/macos
          
    - name: ðŸ“¦ Create macOS package
      run: |
        VERSION="${{ github.event.release.tag_name || inputs.version }}"
        
        # åˆ›å»º DMG åŒ…çš„ä¸´æ—¶ç›®å½•
        mkdir -p ./dmg-temp
        
        # å¤åˆ¶åº”ç”¨åˆ°ä¸´æ—¶ç›®å½•
        cp -R ./publish/macos/*.app ./dmg-temp/
        
        # åˆ›å»ºåº”ç”¨ç¨‹åºé“¾æŽ¥
        ln -s /Applications ./dmg-temp/Applications
        
        # åˆ›å»º README
        cat > ./dmg-temp/README.txt << EOF
        WorkTimeTracker for macOS
        
        Installation:
        1. Drag WorkTimeTracker.app to Applications folder
        2. Open Applications and launch WorkTimeTracker
        
        Requirements:
        - macOS 10.15 or later
        - .NET 9.0 Runtime (will be installed automatically)
        
        Version: $VERSION
        Build Date: $(date)
        EOF
        
        # åˆ›å»º tar.gz åŒ… (ç®€åŒ–ç‰ˆï¼Œå®žé™…çŽ¯å¢ƒä¸­å¯ä»¥åˆ›å»º DMG)
        tar -czf "./WorkTimeTracker-macOS-$VERSION.tar.gz" -C ./dmg-temp .
        
    - name: ðŸ“¤ Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: macos-package
        path: "./WorkTimeTracker-macOS-*.tar.gz"
        retention-days: 30

  # Linux æž„å»º (å¯é€‰)
  build-linux:
    name: ðŸ§ Build Linux
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore WorkTimeTracker.sln
      
    - name: ðŸ”¨ Build Linux libraries
      run: |
        # æž„å»ºæ ¸å¿ƒåº“ï¼ˆå¯åœ¨ Linux ä¸Šä½¿ç”¨ï¼‰
        dotnet publish WorkTimeTracker.Core/WorkTimeTracker.Core.csproj \
          -c Release \
          -p:RuntimeIdentifier=linux-x64 \
          --self-contained false \
          --output ./publish/linux/core
          
        dotnet publish WorkTimeTracker.Data/WorkTimeTracker.Data.csproj \
          -c Release \
          -p:RuntimeIdentifier=linux-x64 \
          --self-contained false \
          --output ./publish/linux/data
          
    - name: ðŸ“¦ Create Linux package
      run: |
        VERSION="${{ github.event.release.tag_name || inputs.version }}"
        
        # åˆ›å»º Linux åŒ…ç›®å½•
        mkdir -p ./linux-package
        
        # å¤åˆ¶åº“æ–‡ä»¶
        cp -R ./publish/linux/* ./linux-package/
        
        # åˆ›å»ºæ–‡æ¡£
        cat > ./linux-package/README.md << EOF
        # WorkTimeTracker Libraries for Linux
        
        This package contains the core libraries for WorkTimeTracker that can be used on Linux systems.
        
        ## Contents
        - WorkTimeTracker.Core: Business logic library
        - WorkTimeTracker.Data: Data access library
        
        ## Requirements
        - .NET 9.0 Runtime
        - SQLite3
        
        ## Version
        $VERSION
        
        ## Usage
        These libraries can be referenced in Linux-based .NET applications.
        EOF
        
        # åˆ›å»ºåŒ…
        tar -czf "./WorkTimeTracker-Linux-Libraries-$VERSION.tar.gz" -C ./linux-package .
        
    - name: ðŸ“¤ Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-package
        path: "./WorkTimeTracker-Linux-Libraries-*.tar.gz"
        retention-days: 30

  # å‘å¸ƒåˆ° GitHub Releases
  create-release:
    name: ðŸš€ Create Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos, build-linux]
    if: github.event_name == 'workflow_dispatch' && inputs.create_release || github.event_name == 'release'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./release-artifacts
        
    - name: ðŸ“‹ Generate release notes
      run: |
        VERSION="${{ github.event.release.tag_name || inputs.version }}"
        
        cat > release-notes.md << EOF
        # ðŸŽ‰ WorkTimeTracker $VERSION
        
        ä¸€ä¸ªçŽ°ä»£åŒ–çš„å·¥ä½œæ—¶é—´è·Ÿè¸ªåº”ç”¨ç¨‹åºï¼ŒåŸºäºŽ .NET MAUI æž„å»ºã€‚
        
        ## ðŸ“¦ ä¸‹è½½åŒ…
        
        ### æ¡Œé¢åº”ç”¨ç¨‹åº
        - **Windows 10/11**: \`WorkTimeTracker-Windows-$VERSION.zip\`
        - **macOS**: \`WorkTimeTracker-macOS-$VERSION.tar.gz\`
        
        ### å¼€å‘è€…åº“
        - **Linux åº“**: \`WorkTimeTracker-Linux-Libraries-$VERSION.tar.gz\`
        
        ## ðŸ†• æ–°åŠŸèƒ½
        - â° å·¥ä½œæ—¶é—´è·Ÿè¸ª
        - ðŸ”” é€šçŸ¥æé†’åŠŸèƒ½
        - ðŸ“Š å·¥ä½œç»Ÿè®¡å’ŒæŠ¥å‘Š
        - ðŸŽ¨ çŽ°ä»£åŒ– UI ç•Œé¢
        - ðŸ”§ è‡ªå®šä¹‰è®¾ç½®
        
        ## ðŸ› ï¸ æŠ€æœ¯è§„æ ¼
        - **æ¡†æž¶**: .NET 9.0
        - **UI æ¡†æž¶**: .NET MAUI
        - **æ•°æ®åº“**: SQLite
        - **æ”¯æŒå¹³å°**: Windows, macOS
        
        ## ðŸ“± ç³»ç»Ÿè¦æ±‚
        
        ### Windows
        - Windows 10 ç‰ˆæœ¬ 1809 æˆ–æ›´é«˜ç‰ˆæœ¬
        - .NET 9.0 Runtime (è‡ªåŠ¨å®‰è£…)
        
        ### macOS
        - macOS 10.15 (Catalina) æˆ–æ›´é«˜ç‰ˆæœ¬
        - .NET 9.0 Runtime (è‡ªåŠ¨å®‰è£…)
        
        ## ðŸš€ å®‰è£…è¯´æ˜Ž
        
        ### Windows
        1. ä¸‹è½½ \`WorkTimeTracker-Windows-$VERSION.zip\`
        2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•
        3. è¿è¡Œ \`start.bat\` æˆ–ç›´æŽ¥è¿è¡Œ \`WorkTimeTracker.UI.exe\`
        
        ### macOS
        1. ä¸‹è½½ \`WorkTimeTracker-macOS-$VERSION.tar.gz\`
        2. è§£åŽ‹å¹¶å°† \`WorkTimeTracker.app\` æ‹–æ‹½åˆ° Applications æ–‡ä»¶å¤¹
        3. ä»Ž Launchpad æˆ– Applications æ–‡ä»¶å¤¹å¯åŠ¨åº”ç”¨ç¨‹åº
        
        ## ðŸ“ž æ”¯æŒä¸Žåé¦ˆ
        - ðŸ› é—®é¢˜æŠ¥å‘Š: [GitHub Issues](https://github.com/your-repo/WorkTimeTracker/issues)
        - ðŸ’¡ åŠŸèƒ½å»ºè®®: [GitHub Discussions](https://github.com/your-repo/WorkTimeTracker/discussions)
        
        ---
        
        **æž„å»ºä¿¡æ¯**
        - æž„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - æäº¤å“ˆå¸Œ: ${{ github.sha }}
        - æž„å»ºçŽ¯å¢ƒ: GitHub Actions
        EOF
        
    - name: ðŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.release.tag_name || inputs.version }}
        name: WorkTimeTracker ${{ github.event.release.tag_name || inputs.version }}
        body_path: release-notes.md
        files: |
          ./release-artifacts/windows-package/*
          ./release-artifacts/macos-package/*
          ./release-artifacts/linux-package/*
        draft: false
        prerelease: ${{ contains(github.event.release.tag_name, 'alpha') || contains(github.event.release.tag_name, 'beta') || contains(github.event.release.tag_name, 'rc') || contains(inputs.version, 'alpha') || contains(inputs.version, 'beta') || contains(inputs.version, 'rc') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
